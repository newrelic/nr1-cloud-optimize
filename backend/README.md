# Cloud Optimize Backend

This lambda contains the backend code that processes entities with their associated cost and potential instance resizing.

## Requesting and optimization job
- POST request is made to:
  - DEV: https://wh7l38u7v7.execute-api.us-east-1.amazonaws.com/dev/optimize
  - PROD: https://wh7l38u7v7.execute-api.us-east-1.amazonaws.com/devoptimize
    - Headers
      - `nr-api-key` with the value of a NerdGraph User Key that has access to the apprioriate workloads/entities
        - This is required to query entities and write results to nerdstorage
    - Payload
      - An array of workloadGuids should be supplied, the entities within each workload will be inspected
      - accountId key is required to write the results into nerd storage
      - The nerdpackUUID (inside nr1.json, or global catalog), this is also a requirement to write results into nerdstorage
      - collectionId (uuid) should be supplied to identify the collection the results will be written into, this is generated by the requester
  #### Example payload
  ```json
  {
      "workloadGuids": [
          "MTYwNjg2MnxOUjF8V09SS0xPQUR8NDkyMjg",
          "MTYwNjg2MnxOUjF8V09SS0xPQUR8MzUxMzc",
          "MTYwNjg2MnxOUjF8V09SS0xPQUR8MzUxMzk"
      ],
      "accountId": 1606862,
      "nerdpackUUID": "7e874b6e-c010-4933-a15d-ea5b2e54d029",
      "collectionId": "5a6aaefe-7299-4f5f-b33a-bf2fe7c2046d",
      "config": {}
  }
  ```
- When the POST request is made, you should immediately be returned a payload with a jobId
  - You can use this jobId to track when your specific results are completed are returned when querying NerdStorage, or just poll the collection.
  - When the job is sent, it is sent to another lambda to process which can take up to 15m max, anything longer than this can be considered a failure

## Accessing results
- To access the jobStatus, within your nerdpack use the AccountStorageQuery component and query the account you selected and the `jobStatus` collection
    - Example fetchJobStatus function in nerdlets/results/context/data 

- To access the results per workload you can use the EntityStorageQuery component to query the workload entities, and the `optimizerResults` collection
  - Results can be sharded across multiple documents so you will need to check
    - Example fetchWorkloads function in nerdlets/results/context/data 

